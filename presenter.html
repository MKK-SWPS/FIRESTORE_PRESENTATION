<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Presenter — Slide Heatmap</title>
<style>
  :root { --bg:#0b0f14; --fg:#e8edf2; --muted:#9aa4af; --accent:#4ea1ff; }
  html,body { margin:0; height:100%; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  .wrap { max-width:1100px; margin:0 auto; padding:16px; display:flex; flex-direction:column; gap:12px; }
  header { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
  h1 { font-size:18px; margin:0; }
  .muted { color:var(--muted); font-size:13px; }
  .panel { background:#0f141b; border:1px solid #1f2732; border-radius:14px; padding:12px; }
  .stats { display:flex; gap:10px; flex-wrap:wrap; }
  .stat { background:#121923; border:1px solid #1f2732; border-radius:10px; padding:6px 10px; font-size:13px; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  button { background:#151b23; color:var(--fg); border:1px solid #1f2732; border-radius:10px; padding:8px 12px; cursor:pointer; }
  button.primary { background:var(--accent); color:#001428; border:0; }
  .stage { position:relative; width:100%; aspect-ratio:16/9; background:#0a0e13; border-radius:12px; overflow:hidden; border:1px solid #1f2732; }
  .stage img { width:100%; height:100%; object-fit:contain; display:block; }
  canvas.overlay { position:absolute; inset:0; pointer-events:none; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Presenter — Slide Heatmap</h1>
    <div class="muted">Flip slides here; students tap on <b>student.html</b>.</div>
  </header>

  <div class="panel">
    <div class="stats">
      <div class="stat">Session: <span id="sessionId"></span></div>
      <div class="stat">Slide <span id="slideIdx">1</span>/<span id="slideTotal">1</span></div>
      <div class="stat">Taps: <span id="tapCount">0</span></div>
    </div>
    <div class="controls" style="margin-top:10px;">
      <button id="prevBtn">◀ Prev</button>
      <button id="nextBtn" class="primary">Next ▶</button>
      <button id="clearBtn" title="Clear taps on current slide only">Clear Slide</button>
      <button id="toggleHeatBtn">Toggle Heatmap</button>
    </div>
  </div>

  <div class="stage panel" id="stage">
    <img id="slideImg" alt="Slide" />
    <canvas id="heatCanvas" class="overlay"></canvas>
  </div>

  <div class="muted">Heatmap updates live from student taps. Changing slides only shows taps for the new slide.</div>
</div>

<script type="module">
/*** ── CONFIG (edit these) ── ***/
const FIREBASE_CONFIG = {
  // Replace with your Firebase project credentials:
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  appId: "YOUR_APP_ID",
};
const SESSION_ID = "demo-session-001"; // e.g., "lecture-2025-09-17"
const SLIDE_IMAGES = [
  // Replace with your exported slide image URLs (e.g., "slides/001.png")
  "https://images.unsplash.com/photo-1529107386315-e1a2ed48a620?q=80&w=1920&auto=format&fit=crop",
  "https://images.unsplash.com/photo-1543286386-713bdd548da4?q=80&w=1920&auto=format&fit=crop",
  "https://images.unsplash.com/photo-1532614338840-ab30cf10ed36?q=80&w=1920&auto=format&fit=crop"
];
const HEAT_RADIUS_BASE = 80;   // px at 1920 width
const HEAT_INTENSITY  = 0.25;  // 0..1 per tap

/*** ── App (no external deps) ── ***/
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = initializeApp(FIREBASE_CONFIG);
const db  = getFirestore(app);
const auth = getAuth(app);
await signInAnonymously(auth).catch(()=>{});

const $ = id => document.getElementById(id);
const stage = $("stage"), imgEl = $("slideImg"), heatCanvas = $("heatCanvas");
$("sessionId").textContent = SESSION_ID;
$("slideTotal").textContent = SLIDE_IMAGES.length;

let currentSlide = 0;
let showHeatmap = true;
let unsubResp = null;
let points = []; // {x,y} normalized 0..1 inside the image area (not letterbox)

function computeImageRect(){
  const r = stage.getBoundingClientRect();
  const W = Math.floor(r.width), H = Math.floor(r.height);
  const iw = imgEl.naturalWidth || 1920, ih = imgEl.naturalHeight || 1080;
  const ia = iw/ih, ca = W/H;
  if (ca > ia) {
    const h = H, w = Math.round(h*ia), x = Math.round((W - w)/2), y = 0;
    return {x,y,w,h, W, H};
  } else {
    const w = W, h = Math.round(w/ia), x = 0, y = Math.round((H - h)/2);
    return {x,y,w,h, W, H};
  }
}
function resizeCanvas(){
  const r = stage.getBoundingClientRect();
  heatCanvas.width = Math.floor(r.width);
  heatCanvas.height = Math.floor(r.height);
  drawHeatmap();
}
window.addEventListener("resize", resizeCanvas);

function drawHeatmap(){
  const ctx = heatCanvas.getContext("2d");
  ctx.clearRect(0,0,heatCanvas.width,heatCanvas.height);
  if(!showHeatmap) return;
  const rect = computeImageRect();
  const base = HEAT_RADIUS_BASE * (rect.w/1920);
  for(const p of points){
    const cx = rect.x + p.x*rect.w;
    const cy = rect.y + p.y*rect.h;
    const r = base;
    const g = ctx.createRadialGradient(cx,cy,0,cx,cy,r);
    g.addColorStop(0, `rgba(78,161,255,${HEAT_INTENSITY})`);
    g.addColorStop(1, `rgba(78,161,255,0)`);
    ctx.fillStyle = g;
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
  }
  $("tapCount").textContent = String(points.length);
}

function listenResponses(){
  if (unsubResp) unsubResp();
  points = [];
  drawHeatmap();
  const col = collection(db, "sessions", SESSION_ID, "slides", String(currentSlide), "responses");
  unsubResp = onSnapshot(col, (snap) => {
    const pts = [];
    snap.forEach(d => {
      const r = d.data();
      if (typeof r.x === "number" && typeof r.y === "number") pts.push({x:r.x, y:r.y});
    });
    points = pts;
    drawHeatmap();
  });
}

async function ensureSession(){
  const sessRef = doc(db, "sessions", SESSION_ID);
  const s = await getDoc(sessRef);
  if(!s.exists()) {
    await setDoc(sessRef, { slideIndex: 0, total: SLIDE_IMAGES.length, createdAt: Date.now() });
  }
}

function setSlide(i){
  currentSlide = Math.max(0, Math.min(SLIDE_IMAGES.length - 1, i));
  $("slideIdx").textContent = String(currentSlide + 1);
  imgEl.src = SLIDE_IMAGES[currentSlide];
  const sessRef = doc(db, "sessions", SESSION_ID);
  setDoc(sessRef, { slideIndex: currentSlide, total: SLIDE_IMAGES.length, updatedAt: Date.now() }, { merge:true });
  listenResponses(); // subscribes to current slide, clearing old heatmap
}
imgEl.onload = resizeCanvas;

$("prevBtn").onclick = () => setSlide(currentSlide - 1);
$("nextBtn").onclick = () => setSlide(currentSlide + 1);
$("toggleHeatBtn").onclick = () => { showHeatmap = !showHeatmap; drawHeatmap(); };
$("clearBtn").onclick = async () => {
  const col = collection(db, "sessions", SESSION_ID, "slides", String(currentSlide), "responses");
  const snap = await getDocs(col);
  const deletions = [];
  snap.forEach(d => deletions.push(deleteDoc(d.ref)));
  await Promise.all(deletions);
  points = [];
  drawHeatmap();
};

await ensureSession();
setSlide(0);
</script>
</body>
</html>